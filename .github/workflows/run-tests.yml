name: Selenium Test Suite - Cross Browser Parallel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    strategy:
      matrix:
        browser: [chrome, edge]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install Chrome and Chromedriver
        if: matrix.browser == 'chrome'
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f1)
          DRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_VERSION}")
          echo "Chrome version: $(google-chrome --version)"
          echo "Chromedriver version: $DRIVER_VERSION"
          wget -O chromedriver.zip "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${DRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          unzip chromedriver.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          chmod +x /usr/local/bin/chromedriver

      - name: Install Edge and EdgeDriver
        if: matrix.browser == 'edge'
        run: |
          # Install Microsoft Edge
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-dev.list'
          sudo apt-get update
          sudo apt-get install -y microsoft-edge-stable
          
          # Get Edge version and install matching EdgeDriver
          EDGE_VERSION=$(microsoft-edge --version | awk '{print $3}' | cut -d '.' -f1)
          echo "Edge version: $(microsoft-edge --version)"
          echo "Edge major version: $EDGE_VERSION"
          
          # Download and install EdgeDriver
          DRIVER_VERSION=$(curl -s "https://msedgedriver.azureedge.net/LATEST_RELEASE_${EDGE_VERSION}_LINUX")
          echo "EdgeDriver version: $DRIVER_VERSION"
          wget -O edgedriver.zip "https://msedgedriver.azureedge.net/${DRIVER_VERSION}/edgedriver_linux64.zip"
          unzip edgedriver.zip
          sudo mv msedgedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/msedgedriver
          
          # Verify installation
          echo "EdgeDriver installed at: $(which msedgedriver)"
          msedgedriver --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Keyword-Driven Test Data
        run: python create_fresh_test_data.py

      - name: Enforce Headless Mode for Tests
        run: |
          sed -i 's/^headless_mode = False/headless_mode = True/' selenium_demoblaze_framework/config/config.ini

      - name: Add Edge-specific configurations
        if: matrix.browser == 'edge'
        run: |
          # Create a temporary config for Edge if needed
          echo "Edge browser selected - ensuring compatibility settings"

      - name: Run Pytest with Parallel Execution
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest selenium_demoblaze_framework/tests/ \
            --browser=${{ matrix.browser }} \
            -n 4 \
            --dist loadgroup \
            --html=reports/test-report-${{ matrix.browser }}.html \
            --self-contained-html \
            --alluredir=reports/allure-results-${{ matrix.browser }} \
            -v \
            --tb=short \
            --maxfail=5

      - name: Upload HTML Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-test-report-${{ matrix.browser }}
          path: reports/test-report-${{ matrix.browser }}.html

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: reports/allure-results-${{ matrix.browser }}

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: reports/screenshots
        continue-on-error: true

  deploy-reports:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Combine Allure Results
        run: |
          mkdir -p reports/allure-results
          find artifacts -name "allure-results-*" -type d | while read dir; do
            cp -r "$dir"/* reports/allure-results/ 2>/dev/null || true
          done
          echo "Combined allure results from all browsers"
          ls -la reports/allure-results/

      - name: Generate Combined Allure Report
        uses: simple-elf/allure-report-action@v1.7
        with:
          allure_results: reports/allure-results
          allure_history: allure-history
          keep_reports: 20
          gh_pages: gh-pages

      - name: Upload Combined Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-combined
          path: allure-report

      - name: Prepare Reports for GitHub Pages
        run: |
          mkdir -p deploy
          
          if [ -d "allure-history" ]; then
            cp -r allure-history/* deploy/ 2>/dev/null || true
          fi
          
          mkdir -p deploy/html-reports
          
          for browser in chrome edge; do
            if [ -f "artifacts/html-test-report-${browser}/test-report-${browser}.html" ]; then
              cp "artifacts/html-test-report-${browser}/test-report-${browser}.html" \
                 "deploy/html-reports/report-${browser}-${{ github.run_number }}.html"
              echo "Copied ${browser} HTML report"
            fi
          done
          
          mkdir -p deploy/screenshots
          find artifacts -name "screenshots-*" -type d | while read dir; do
            cp -r "$dir"/* deploy/screenshots/ 2>/dev/null || true
          done
          
          cat > deploy/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Cross-Browser Test Reports - Selenium DemoBlaze</title>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                  }
                  .container {
                      background: white;
                      border-radius: 12px;
                      padding: 40px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      max-width: 1000px;
                      width: 100%;
                      animation: fadeIn 0.5s ease-in;
                  }
                  @keyframes fadeIn {
                      from { opacity: 0; transform: translateY(20px); }
                      to { opacity: 1; transform: translateY(0); }
                  }
                  h1 {
                      color: #2c3e50;
                      text-align: center;
                      margin-bottom: 10px;
                      font-size: 2.5em;
                  }
                  .subtitle {
                      text-align: center;
                      color: #7f8c8d;
                      margin-bottom: 30px;
                      font-size: 1.1em;
                  }
                  .badge {
                      display: inline-block;
                      padding: 5px 12px;
                      border-radius: 20px;
                      font-size: 0.85em;
                      font-weight: 600;
                      margin: 0 5px;
                  }
                  .badge-chrome {
                      background: #4285f4;
                      color: white;
                  }
                  .badge-edge {
                      background: #0078d7;
                      color: white;
                  }
                  .badge-parallel {
                      background: #28a745;
                      color: white;
                  }
                  .info-box {
                      background: #f8f9fa;
                      border-left: 4px solid #667eea;
                      padding: 20px;
                      border-radius: 8px;
                      margin-bottom: 30px;
                  }
                  .info-box p {
                      margin: 5px 0;
                      color: #555;
                  }
                  .info-box strong {
                      color: #333;
                      font-weight: 600;
                  }
                  .reports-section {
                      display: grid;
                      grid-template-columns: 1fr;
                      gap: 20px;
                      margin-bottom: 30px;
                  }
                  .report-card {
                      background: white;
                      border: 2px solid #e0e0e0;
                      border-radius: 10px;
                      padding: 25px;
                      text-align: center;
                      transition: all 0.3s ease;
                  }
                  .report-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
                      border-color: #667eea;
                  }
                  .report-card h3 {
                      color: #2c3e50;
                      margin-bottom: 10px;
                      font-size: 1.5em;
                  }
                  .report-card p {
                      color: #7f8c8d;
                      margin-bottom: 20px;
                      font-size: 0.95em;
                  }
                  .btn {
                      display: inline-block;
                      padding: 12px 30px;
                      color: white;
                      text-decoration: none;
                      border-radius: 6px;
                      font-weight: 500;
                      transition: all 0.3s ease;
                      font-size: 1em;
                      margin: 5px;
                  }
                  .btn-allure {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  }
                  .btn-allure:hover {
                      transform: scale(1.05);
                      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
                  }
                  .btn-chrome {
                      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
                  }
                  .btn-chrome:hover {
                      transform: scale(1.05);
                      box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
                  }
                  .btn-edge {
                      background: linear-gradient(135deg, #0078d7 0%, #00bcf2 100%);
                  }
                  .btn-edge:hover {
                      transform: scale(1.05);
                      box-shadow: 0 5px 15px rgba(0, 120, 215, 0.4);
                  }
                  .browser-reports {
                      display: flex;
                      justify-content: center;
                      flex-wrap: wrap;
                      margin-top: 20px;
                      gap: 10px;
                  }
                  .emoji {
                      font-size: 1.5em;
                      margin-bottom: 10px;
                  }
                  .timestamp {
                      text-align: center;
                      color: #95a5a6;
                      font-size: 0.85em;
                      margin-top: 20px;
                  }
                  .feature-list {
                      background: #e8f4f8;
                      border-radius: 8px;
                      padding: 20px;
                      margin: 20px 0;
                  }
                  .feature-list h4 {
                      color: #2c3e50;
                      margin-bottom: 15px;
                      display: flex;
                      align-items: center;
                      gap: 10px;
                  }
                  .feature-list ul {
                      list-style: none;
                      padding-left: 0;
                  }
                  .feature-list li {
                      padding: 8px 0;
                      color: #555;
                  }
                  .feature-list li::before {
                      content: "‚úì ";
                      color: #28a745;
                      font-weight: bold;
                      margin-right: 8px;
                  }
                  .history-section {
                      margin-top: 30px;
                      padding-top: 30px;
                      border-top: 2px solid #e0e0e0;
                  }
                  .history-section h3 {
                      color: #2c3e50;
                      margin-bottom: 15px;
                      text-align: center;
                  }
                  .history-links {
                      display: flex;
                      flex-wrap: wrap;
                      gap: 10px;
                      justify-content: center;
                  }
                  .history-link {
                      padding: 8px 16px;
                      background: #f8f9fa;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                      text-decoration: none;
                      color: #555;
                      transition: all 0.3s ease;
                      font-size: 0.9em;
                  }
                  .history-link:hover {
                      background: #667eea;
                      color: white;
                      border-color: #667eea;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üß™ Cross-Browser Test Reports</h1>
                  <p class="subtitle">
                      Selenium DemoBlaze Automation
                      <br>
                      <span class="badge badge-chrome">Chrome</span>
                      <span class="badge badge-edge">Edge</span>
                      <span class="badge badge-parallel">Parallel Execution</span>
                  </p>
                  
                  <div class="info-box">
                      <p><strong>üì¶ Repository:</strong> ${{ github.repository }}</p>
                      <p><strong>üèÉ Run Number:</strong> #${{ github.run_number }}</p>
                      <p><strong>üåø Branch:</strong> ${{ github.ref_name }}</p>
                      <p><strong>üî® Commit:</strong> <code>${{ github.sha }}</code></p>
                      <p><strong>üë§ Actor:</strong> ${{ github.actor }}</p>
                  </div>

                  <div class="feature-list">
                      <h4>üöÄ Test Execution Features</h4>
                      <ul>
                          <li>Cross-browser testing on Chrome and Edge</li>
                          <li>Parallel test execution with pytest-xdist (4 workers)</li>
                          <li>Thread-safe screenshot handling</li>
                          <li>Comprehensive Allure reporting with trends</li>
                          <li>Browser-specific HTML reports</li>
                          <li>Automated report history tracking</li>
                      </ul>
                  </div>

                  <div class="reports-section">
                      <div class="report-card">
                          <div class="emoji">üìä</div>
                          <h3>Combined Allure Report</h3>
                          <p>Interactive test report combining results from all browsers with detailed execution info, trends, and history</p>
                          <a href="${{ github.run_number }}/" class="btn btn-allure">Open Allure Report</a>
                      </div>
                      
                      <div class="report-card">
                          <div class="emoji">üåê</div>
                          <h3>Browser-Specific HTML Reports</h3>
                          <p>Detailed HTML reports generated by pytest-html for each browser</p>
                          <div class="browser-reports">
                              <a href="html-reports/report-chrome-${{ github.run_number }}.html" class="btn btn-chrome">
                                  Chrome Report
                              </a>
                              <a href="html-reports/report-edge-${{ github.run_number }}.html" class="btn btn-edge">
                                  Edge Report
                              </a>
                          </div>
                      </div>
                  </div>

                  <div class="history-section">
                      <h3>üìö Previous Reports</h3>
                      <div class="history-links" id="history-links">
                      </div>
                  </div>

                  <div class="timestamp">
                      Generated on: <span id="timestamp"></span>
                  </div>
              </div>

              <script>
                  document.getElementById('timestamp').textContent = new Date().toLocaleString();
                  
                  const currentRun = ${{ github.run_number }};
                  const historyContainer = document.getElementById('history-links');
                  
                  for(let i = currentRun - 1; i > Math.max(0, currentRun - 10); i--) {
                      const linkDiv = document.createElement('div');
                      linkDiv.style.display = 'inline-block';
                      linkDiv.innerHTML = `
                          <a href="${i}/" class="history-link" title="View Run #${i}">
                              Run #${i}
                          </a>
                      `;
                      historyContainer.appendChild(linkDiv);
                  }
                  
                  if (currentRun <= 1) {
                      historyContainer.innerHTML = '<p style="color: #95a5a6;">No previous reports available</p>';
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: deploy
          force_orphan: false
          keep_files: false

      - name: Post Report URLs
        run: |
          echo "### üìä Cross-Browser Test Reports Published! üéâ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üåê Main Dashboard:** https://roykunaljit.github.io/selenium-demoblaze-automations/" >> $GITHUB_STEP_SUMMARY
          echo "**üìà Combined Allure Report:** https://roykunaljit.github.io/selenium-demoblaze-automations/${{ github.run_number }}/" >> $GITHUB_STEP_SUMMARY
          echo "**üîµ Chrome HTML Report:** https://roykunaljit.github.io/selenium-demoblaze-automations/html-reports/report-chrome-${{ github.run_number }}.html" >> $GITHUB_STEP_SUMMARY
          echo "**üî∑ Edge HTML Report:** https://roykunaljit.github.io/selenium-demoblaze-automations/html-reports/report-edge-${{ github.run_number }}.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Tests executed on Chrome and Edge in parallel" >> $GITHUB_STEP_SUMMARY
          echo "‚ö° Parallel execution with 4 workers per browser" >> $GITHUB_STEP_SUMMARY
          echo "üîí Thread-safe screenshot and report generation" >> $GITHUB_STEP_SUMMARY
          echo "üì∏ Screenshots available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY